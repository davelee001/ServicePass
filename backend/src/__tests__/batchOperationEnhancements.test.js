const batchOperationManager = require('../../../src/utils/batchOperationManager');\nconst BatchOperation = require('../../../src/models/BatchOperation');\nconst { connectDB, clearDB, closeDB } = require('../setup');\n\ndescribe('Enhanced Batch Operation Manager', () => {\n    beforeAll(async () => {\n        await connectDB();\n    });\n    \n    afterAll(async () => {\n        await closeDB();\n    });\n    \n    beforeEach(async () => {\n        await clearDB();\n        \n        // Clear manager state\n        batchOperationManager.activeOperations.clear();\n        batchOperationManager.pausedOperations.clear();\n        batchOperationManager.operationQueues.clear();\n    });\n    \n    describe('Batch Operation Creation', () => {\n        test('should create batch operation with default options', async () => {\n            const data = [\n                { voucherType: '1', amount: 100, recipient: '0x' + '1'.repeat(64), merchantId: 'MERCHANT_001' },\n                { voucherType: '2', amount: 200, recipient: '0x' + '2'.repeat(64), merchantId: 'MERCHANT_002' }\n            ];\n            \n            const result = await batchOperationManager.createBatchOperation(\n                'bulk_mint_vouchers',\n                data,\n                { userId: 'test-user' }\n            );\n            \n            expect(result.batchId).toBeDefined();\n            expect(result.status).toBe('queued');\n            expect(result.totalRecords).toBe(2);\n            expect(result.estimatedDuration).toBeDefined();\n            \n            // Check database record\n            const dbOperation = await BatchOperation.findOne({ batchId: result.batchId });\n            expect(dbOperation).toBeTruthy();\n            expect(dbOperation.operationType).toBe('bulk_mint_vouchers');\n            expect(dbOperation.totalRecords).toBe(2);\n        });\n        \n        test('should respect custom batch options', async () => {\n            const data = new Array(10).fill().map((_, i) => ({\n                voucherType: '1',\n                amount: 100 + i,\n                recipient: '0x' + i.toString().repeat(64).slice(0, 64),\n                merchantId: `MERCHANT_${String(i).padStart(3, '0')}`\n            }));\n            \n            const result = await batchOperationManager.createBatchOperation(\n                'bulk_mint_vouchers',\n                data,\n                {\n                    userId: 'test-user',\n                    batchSize: 3,\n                    priority: 'high',\n                    parallelProcessing: false\n                }\n            );\n            \n            const dbOperation = await BatchOperation.findOne({ batchId: result.batchId });\n            expect(dbOperation.batchSize).toBe(3);\n            expect(dbOperation.metadata.priority).toBe('high');\n            expect(dbOperation.parameters.parallelProcessing).toBe(false);\n        });\n        \n        test('should generate unique batch IDs', async () => {\n            const data = [{ test: 'data' }];\n            \n            const result1 = await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user' }\n            );\n            \n            const result2 = await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user' }\n            );\n            \n            expect(result1.batchId).not.toBe(result2.batchId);\n        });\n    });\n    \n    describe('Queue Management', () => {\n        test('should add operations to priority queues', async () => {\n            const data = [{ test: 'data' }];\n            \n            await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user', priority: 'high' }\n            );\n            \n            await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user', priority: 'low' }\n            );\n            \n            expect(batchOperationManager.operationQueues.has('high')).toBe(true);\n            expect(batchOperationManager.operationQueues.has('low')).toBe(true);\n            expect(batchOperationManager.operationQueues.get('high').length).toBe(1);\n            expect(batchOperationManager.operationQueues.get('low').length).toBe(1);\n        });\n        \n        test('should sort queues by priority', async () => {\n            const data = [{ test: 'data' }];\n            \n            // Create operations in different priority order\n            await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user', priority: 'low' }\n            );\n            \n            await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user', priority: 'high' }\n            );\n            \n            const queueKeys = Array.from(batchOperationManager.operationQueues.keys());\n            expect(queueKeys[0]).toBe('high');\n            expect(queueKeys[1]).toBe('low');\n        });\n    });\n    \n    describe('Chunk Processing', () => {\n        test('should create correct chunks from data', async () => {\n            const data = new Array(10).fill().map((_, i) => ({ item: i }));\n            const chunks = batchOperationManager.createChunks(data, 3);\n            \n            expect(chunks.length).toBe(4); // 10 items with chunk size 3 = 4 chunks\n            expect(chunks[0].length).toBe(3);\n            expect(chunks[1].length).toBe(3);\n            expect(chunks[2].length).toBe(3);\n            expect(chunks[3].length).toBe(1); // Last chunk has remaining items\n        });\n        \n        test('should handle data smaller than chunk size', async () => {\n            const data = [{ item: 1 }, { item: 2 }];\n            const chunks = batchOperationManager.createChunks(data, 5);\n            \n            expect(chunks.length).toBe(1);\n            expect(chunks[0].length).toBe(2);\n        });\n    });\n    \n    describe('Operation Status Management', () => {\n        test('should get operation status', async () => {\n            const data = [{ test: 'data' }];\n            \n            const result = await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user' }\n            );\n            \n            const status = await batchOperationManager.getOperationStatus(result.batchId);\n            \n            expect(status.batchId).toBe(result.batchId);\n            expect(status.operationType).toBe('bulk_notifications');\n            expect(status.status).toBe('queued');\n            expect(status.totalRecords).toBe(1);\n            expect(status.processedRecords).toBe(0);\n        });\n        \n        test('should return error for non-existent operation', async () => {\n            const status = await batchOperationManager.getOperationStatus('non-existent-id');\n            \n            expect(status.error).toBe('Operation not found');\n        });\n    });\n    \n    describe('User Operations', () => {\n        test('should get user operations with pagination', async () => {\n            const userId = 'test-user';\n            const data = [{ test: 'data' }];\n            \n            // Create multiple operations\n            for (let i = 0; i < 5; i++) {\n                await batchOperationManager.createBatchOperation(\n                    'bulk_notifications',\n                    data,\n                    { userId }\n                );\n            }\n            \n            const operations = await batchOperationManager.getUserOperations(userId, 3, 0);\n            \n            expect(operations.length).toBe(3);\n            expect(operations[0].initiatedBy).toBe(userId);\n        });\n        \n        test('should respect pagination offset', async () => {\n            const userId = 'test-user';\n            const data = [{ test: 'data' }];\n            \n            // Create multiple operations\n            for (let i = 0; i < 5; i++) {\n                await batchOperationManager.createBatchOperation(\n                    'bulk_notifications',\n                    data,\n                    { userId }\n                );\n            }\n            \n            const page1 = await batchOperationManager.getUserOperations(userId, 2, 0);\n            const page2 = await batchOperationManager.getUserOperations(userId, 2, 2);\n            \n            expect(page1.length).toBe(2);\n            expect(page2.length).toBe(2);\n            expect(page1[0]._id).not.toEqual(page2[0]._id);\n        });\n    });\n    \n    describe('Operation Control', () => {\n        test('should cancel operation', async () => {\n            const data = [{ test: 'data' }];\n            \n            const result = await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user' }\n            );\n            \n            const cancelResult = await batchOperationManager.cancelOperation(result.batchId);\n            \n            expect(cancelResult.success).toBe(true);\n            expect(cancelResult.message).toContain('cancelled successfully');\n            \n            // Check database status\n            const dbOperation = await BatchOperation.findOne({ batchId: result.batchId });\n            expect(dbOperation.status).toBe('cancelled');\n        });\n        \n        test('should fail to cancel non-existent operation', async () => {\n            await expect(\n                batchOperationManager.cancelOperation('non-existent-id')\n            ).rejects.toThrow('Operation non-existent-id not found');\n        });\n    });\n    \n    describe('Metrics and Analytics', () => {\n        test('should provide system metrics', async () => {\n            const metrics = batchOperationManager.getMetrics();\n            \n            expect(metrics).toHaveProperty('totalOperations');\n            expect(metrics).toHaveProperty('successfulOperations');\n            expect(metrics).toHaveProperty('failedOperations');\n            expect(metrics).toHaveProperty('averageProcessingTime');\n            expect(metrics).toHaveProperty('activeOperationsCount');\n            expect(metrics).toHaveProperty('pausedOperationsCount');\n            expect(metrics).toHaveProperty('queuedOperationsCount');\n        });\n        \n        test('should update metrics when operations are created', async () => {\n            const initialMetrics = batchOperationManager.getMetrics();\n            \n            const data = [{ test: 'data' }];\n            await batchOperationManager.createBatchOperation(\n                'bulk_notifications',\n                data,\n                { userId: 'test-user' }\n            );\n            \n            const updatedMetrics = batchOperationManager.getMetrics();\n            \n            expect(updatedMetrics.totalOperations).toBe(initialMetrics.totalOperations + 1);\n        });\n    });\n    \n    describe('Time Estimation', () => {\n        test('should estimate processing time', async () => {\n            const mockOperation = {\n                totalRecords: 100,\n                batchSize: 10\n            };\n            \n            const estimatedTime = batchOperationManager.estimateProcessingTime(mockOperation);\n            \n            expect(estimatedTime).toBeGreaterThan(0);\n            expect(typeof estimatedTime).toBe('number');\n        });\n        \n        test('should provide reasonable estimates', async () => {\n            const smallOperation = {\n                totalRecords: 10,\n                batchSize: 5\n            };\n            \n            const largeOperation = {\n                totalRecords: 1000,\n                batchSize: 50\n            };\n            \n            const smallTime = batchOperationManager.estimateProcessingTime(smallOperation);\n            const largeTime = batchOperationManager.estimateProcessingTime(largeOperation);\n            \n            expect(largeTime).toBeGreaterThan(smallTime);\n        });\n    });\n    \n    describe('Duration Formatting', () => {\n        test('should format duration in seconds', async () => {\n            const duration = batchOperationManager.formatDuration(5000); // 5 seconds\n            expect(duration).toBe('5s');\n        });\n        \n        test('should format duration in minutes and seconds', async () => {\n            const duration = batchOperationManager.formatDuration(125000); // 2 minutes 5 seconds\n            expect(duration).toBe('2m 5s');\n        });\n        \n        test('should format duration in hours, minutes, and seconds', async () => {\n            const duration = batchOperationManager.formatDuration(3725000); // 1 hour 2 minutes 5 seconds\n            expect(duration).toBe('1h 2m 5s');\n        });\n    });\n    \n    describe('Virtual Properties', () => {\n        test('should calculate completion percentage", async () => {\n            const operation = new BatchOperation({\n                batchId: 'test-123',\n                operationType: 'bulk_notifications',\n                initiatedBy: 'test-user',\n                totalRecords: 100,\n                processedRecords: 25,\n                parameters: { data: [] }\n            });\n            \n            expect(operation.completionPercentage).toBe(25);\n        });\n        \n        test('should calculate success rate', async () => {\n            const operation = new BatchOperation({\n                batchId: 'test-123',\n                operationType: 'bulk_notifications',\n                initiatedBy: 'test-user',\n                totalRecords: 100,\n                processedRecords: 50,\n                successfulRecords: 40,\n                parameters: { data: [] }\n            });\n            \n            expect(operation.successRate).toBe(80); // 40/50 * 100\n        });\n        \n        test('should handle zero division in virtual properties", async () => {\n            const operation = new BatchOperation({\n                batchId: 'test-123',\n                operationType: 'bulk_notifications',\n                initiatedBy: 'test-user',\n                totalRecords: 0,\n                processedRecords: 0,\n                parameters: { data: [] }\n            });\n            \n            expect(operation.completionPercentage).toBe(0);\n            expect(operation.successRate).toBe(0);\n        });\n    });\n});